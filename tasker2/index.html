<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .task-item:hover .task-actions {
            opacity: 1;
        }
        
        .task-actions {
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .checklist-progress {
            height: 3px;
            transition: width 0.3s ease;
        }
        
        .sidebar {
            transition: transform 0.3s ease;
        }
        
        .sidebar-mobile-hidden {
            transform: translateX(-100%);
        }
        
        .task-dragging {
            opacity: 0.5;
            background-color: #f3f4f6;
        }
        
        .dropzone {
            min-height: 50px;
            transition: background-color 0.2s ease;
        }
        
        .dropzone-active {
            background-color: #e5e7eb;
        }
        
        .tag-color-picker {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }
        
        .tag-color-option {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .tag-color-option.selected {
            border-color: #000;
        }
        
        .image-preview {
            max-height: 150px;
            object-fit: contain;
        }
        
        .modal-image {
            max-height: 80vh;
            max-width: 90vw;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">
    <!-- Auth Modal -->
    <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="authModalTitle" class="text-xl font-semibold">Iniciar Sesión</h3>
                    <button onclick="closeAuthModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div id="authTabs" class="flex border-b mb-4">
                    <button onclick="showAuthTab('login')" class="px-4 py-2 font-medium border-b-2 border-blue-500 text-blue-600">Iniciar Sesión</button>
                    <button onclick="showAuthTab('register')" class="px-4 py-2 font-medium text-gray-500 hover:text-gray-700">Registrarse</button>
                </div>
                
                <div id="loginTab">
                    <form id="loginForm" class="space-y-4">
                        <div>
                            <label for="loginEmail" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="loginEmail" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                        </div>
                        <div>
                            <label for="loginPassword" class="block text-sm font-medium text-gray-700">Contraseña</label>
                            <input type="password" id="loginPassword" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            Iniciar Sesión
                        </button>
                    </form>
                </div>
                
                <div id="registerTab" class="hidden">
                    <form id="registerForm" class="space-y-4">
                        <div>
                            <label for="registerName" class="block text-sm font-medium text-gray-700">Nombre</label>
                            <input type="text" id="registerName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                        </div>
                        <div>
                            <label for="registerEmail" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="registerEmail" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                        </div>
                        <div>
                            <label for="registerPassword" class="block text-sm font-medium text-gray-700">Contraseña</label>
                            <input type="password" id="registerPassword" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                        </div>
                        <div>
                            <label for="registerConfirmPassword" class="block text-sm font-medium text-gray-700">Confirmar Contraseña</label>
                            <input type="password" id="registerConfirmPassword" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            Registrarse
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Tag Modal -->
    <div id="tagModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="tagModalTitle" class="text-xl font-semibold">Nueva Etiqueta</h3>
                    <button onclick="closeTagModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form id="tagForm" class="space-y-4">
                    <input type="hidden" id="tagId">
                    <div>
                        <label for="tagName" class="block text-sm font-medium text-gray-700">Nombre</label>
                        <input type="text" id="tagName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Color</label>
                        <div class="tag-color-picker">
                            <div class="tag-color-option bg-red-500" onclick="selectTagColor('red-500')"></div>
                            <div class="tag-color-option bg-blue-500" onclick="selectTagColor('blue-500')"></div>
                            <div class="tag-color-option bg-green-500" onclick="selectTagColor('green-500')"></div>
                            <div class="tag-color-option bg-yellow-500" onclick="selectTagColor('yellow-500')"></div>
                            <div class="tag-color-option bg-purple-500" onclick="selectTagColor('purple-500')"></div>
                            <div class="tag-color-option bg-pink-500" onclick="selectTagColor('pink-500')"></div>
                            <div class="tag-color-option bg-indigo-500" onclick="selectTagColor('indigo-500')"></div>
                            <div class="tag-color-option bg-gray-500" onclick="selectTagColor('gray-500')"></div>
                        </div>
                        <input type="hidden" id="tagColor" value="blue-500">
                    </div>
                    
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Guardar Etiqueta
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="relative">
            <button onclick="closeImageModal()" class="absolute top-4 right-4 text-white bg-black bg-opacity-50 rounded-full p-2 hover:bg-opacity-75">
                <i class="fas fa-times"></i>
            </button>
            <img id="modalImage" src="" alt="Imagen de tarea" class="modal-image rounded">
        </div>
    </div>

    <!-- Main Layout -->
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar bg-white w-64 border-r border-gray-200 flex flex-col fixed h-full md:relative z-40 md:translate-x-0 sidebar-mobile-hidden">
            <div class="p-4 border-b border-gray-200">
                <h1 class="text-xl font-bold text-blue-600">Task Manager</h1>
            </div>
            
            <div class="p-4 border-b border-gray-200">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white font-semibold" id="userInitial">U</div>
                    <span id="userName" class="font-medium">Usuario</span>
                </div>
                <button onclick="logout()" class="mt-2 text-sm text-blue-600 hover:text-blue-800">Cerrar Sesión</button>
            </div>
            
            <div class="flex-1 overflow-y-auto">
                <div class="p-4">
                    <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Listas</h2>
                    <ul id="defaultLists">
                        <li><a href="#" onclick="loadTasks('inbox')" class="flex items-center space-x-2 py-2 px-2 rounded hover:bg-gray-100 text-gray-700"><i class="fas fa-inbox w-5"></i> <span>Inbox</span></a></li>
                        <li><a href="#" onclick="loadTasks('today')" class="flex items-center space-x-2 py-2 px-2 rounded hover:bg-gray-100 text-gray-700"><i class="fas fa-calendar-day w-5"></i> <span>Hoy</span></a></li>
                        <li><a href="#" onclick="loadTasks('upcoming')" class="flex items-center space-x-2 py-2 px-2 rounded hover:bg-gray-100 text-gray-700"><i class="fas fa-calendar-week w-5"></i> <span>Próximas</span></a></li>
                        <li><a href="#" onclick="loadTasks('anytime')" class="flex items-center space-x-2 py-2 px-2 rounded hover:bg-gray-100 text-gray-700"><i class="fas fa-clock w-5"></i> <span>En cualquier momento</span></a></li>
                        <li><a href="#" onclick="loadTasks('someday')" class="flex items-center space-x-2 py-2 px-2 rounded hover:bg-gray-100 text-gray-700"><i class="fas fa-calendar-plus w-5"></i> <span>Algún día</span></a></li>
                        <li><a href="#" onclick="loadTasks('logbook')" class="flex items-center space-x-2 py-2 px-2 rounded hover:bg-gray-100 text-gray-700"><i class="fas fa-archive w-5"></i> <span>Logbook</span></a></li>
                    </ul>
                </div>
                
                <div class="p-4 border-t border-gray-200">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Proyectos</h2>
                        <button onclick="showNewProjectForm()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    
                    <div id="newProjectForm" class="mb-2 hidden">
                        <div class="flex space-x-2">
                            <input type="text" id="newProjectName" placeholder="Nombre del proyecto" class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm">
                            <button onclick="addProject()" class="bg-blue-500 text-white px-3 rounded-md hover:bg-blue-600">
                                <i class="fas fa-check"></i>
                            </button>
                            <button onclick="hideNewProjectForm()" class="bg-gray-200 text-gray-700 px-3 rounded-md hover:bg-gray-300">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <ul id="projectsList">
                        <!-- Projects will be added here dynamically -->
                    </ul>
                </div>
                
                <div class="p-4 border-t border-gray-200">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Etiquetas</h2>
                        <button onclick="openTagModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    
                    <ul id="tagsList">
                        <!-- Tags will be added here dynamically -->
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Mobile Header -->
            <div class="md:hidden bg-white border-b border-gray-200 p-4 flex items-center justify-between">
                <button onclick="toggleSidebar()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="text-lg font-bold text-blue-600">Task Manager</h1>
                <div class="w-6"></div> <!-- Spacer for alignment -->
            </div>
            
            <!-- Content Header -->
            <div class="bg-white border-b border-gray-200 p-4">
                <div class="flex justify-between items-center">
                    <h2 id="currentListTitle" class="text-xl font-semibold">Inbox</h2>
                    <div class="flex space-x-2">
                        <div class="relative">
                            <input type="text" id="searchInput" placeholder="Buscar tareas..." class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border pl-8">
                            <i class="fas fa-search absolute left-2 top-3 text-gray-400"></i>
                        </div>
                        <button onclick="showTaskModal()" class="bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                
                <div id="filterTags" class="mt-2 flex flex-wrap gap-2 hidden">
                    <!-- Active filters will appear here -->
                </div>
            </div>
            
            <!-- Task Content -->
            <div class="flex-1 overflow-y-auto p-4">
                <div id="tasksContainer">
                    <!-- Tasks will be loaded here -->
                    <div class="text-center py-10 text-gray-500">
                        <i class="fas fa-tasks text-4xl mb-2"></i>
                        <p>No hay tareas en esta lista</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="taskModalTitle" class="text-xl font-semibold">Nueva Tarea</h3>
                    <button onclick="closeTaskModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form id="taskForm">
                    <input type="hidden" id="taskId">
                    <input type="hidden" id="taskList">
                    
                    <div class="space-y-4">
                        <div>
                            <label for="taskTitle" class="block text-sm font-medium text-gray-700">Título</label>
                            <input type="text" id="taskTitle" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                        </div>
                        
                        <div>
                            <label for="taskNotes" class="block text-sm font-medium text-gray-700">Notas</label>
                            <textarea id="taskNotes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border"></textarea>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="taskDueDate" class="block text-sm font-medium text-gray-700">Fecha de vencimiento</label>
                                <input type="date" id="taskDueDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                            </div>
                            
                            <div>
                                <label for="taskParent" class="block text-sm font-medium text-gray-700">Tarea padre</label>
                                <select id="taskParent" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                                    <option value="">Ninguna</option>
                                    <!-- Parent tasks will be populated here -->
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Etiquetas</label>
                            <div id="taskTagsContainer" class="flex flex-wrap gap-2">
                                <!-- Tags will be added here -->
                            </div>
                            <button type="button" onclick="showTagSelection()" class="mt-2 text-sm text-blue-600 hover:text-blue-800">+ Añadir etiquetas</button>
                        </div>
                        
                        <div id="tagSelection" class="hidden border border-gray-200 rounded-md p-2 mt-2">
                            <div class="flex flex-wrap gap-2 mb-2" id="availableTags">
                                <!-- Available tags will be shown here -->
                            </div>
                            <button type="button" onclick="hideTagSelection()" class="text-sm text-gray-600 hover:text-gray-800">Listo</button>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Checklist</label>
                            <div id="checklistItems">
                                <!-- Checklist items will be added here -->
                            </div>
                            <div class="flex mt-2">
                                <input type="text" id="newChecklistItem" placeholder="Nuevo ítem" class="flex-1 rounded-l-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                                <button type="button" onclick="addChecklistItem()" class="bg-blue-600 text-white px-3 rounded-r-md hover:bg-blue-700">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Imagen adjunta</label>
                            <div id="imagePreviewContainer" class="mb-2 hidden">
                                <img id="imagePreview" src="" alt="Vista previa" class="image-preview mb-2">
                                <button type="button" onclick="removeImage()" class="text-sm text-red-600 hover:text-red-800">Eliminar imagen</button>
                            </div>
                            <input type="file" id="taskImage" accept="image/*" class="hidden" onchange="handleImageUpload(this)">
                            <button type="button" onclick="document.getElementById('taskImage').click()" class="bg-gray-100 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-200">
                                <i class="fas fa-image mr-2"></i>Subir imagen
                            </button>
                        </div>
                        
                        <div class="flex justify-end space-x-2 pt-4">
                            <button type="button" onclick="closeTaskModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">Cancelar</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Guardar</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Floating Add Button (Mobile) -->
    <button id="floatingAddButton" onclick="showTaskModal()" class="fixed bottom-6 right-6 md:hidden bg-blue-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center hover:bg-blue-700 z-30">
        <i class="fas fa-plus text-xl"></i>
    </button>

    <script>
        // State management
        let state = {
            currentUser: null,
            tasks: [],
            projects: [],
            tags: [],
            currentList: 'inbox',
            searchQuery: '',
            activeTagFilters: [],
            draggedTask: null
        };

        // Asegurarse que el estado tiene las estructuras necesarias
        function ensureStateStructure() {
            if (!Array.isArray(state.tasks)) state.tasks = [];
            if (!Array.isArray(state.projects)) state.projects = [];
            if (!Array.isArray(state.tags)) state.tags = [];
            if (!state.currentList) state.currentList = 'inbox';
        }

        // DOM Elements
        const elements = {
            authModal: document.getElementById('authModal'),
            authModalTitle: document.getElementById('authModalTitle'),
            loginTab: document.getElementById('loginTab'),
            registerTab: document.getElementById('registerTab'),
            loginForm: document.getElementById('loginForm'),
            registerForm: document.getElementById('registerForm'),
            sidebar: document.getElementById('sidebar'),
            userInitial: document.getElementById('userInitial'),
            userName: document.getElementById('userName'),
            projectsList: document.getElementById('projectsList'),
            newProjectForm: document.getElementById('newProjectForm'),
            newProjectName: document.getElementById('newProjectName'),
            currentListTitle: document.getElementById('currentListTitle'),
            tasksContainer: document.getElementById('tasksContainer'),
            taskModal: document.getElementById('taskModal'),
            taskModalTitle: document.getElementById('taskModalTitle'),
            taskForm: document.getElementById('taskForm'),
            taskId: document.getElementById('taskId'),
            taskTitle: document.getElementById('taskTitle'),
            taskNotes: document.getElementById('taskNotes'),
            taskDueDate: document.getElementById('taskDueDate'),
            taskParent: document.getElementById('taskParent'),
            taskList: document.getElementById('taskList'),
            taskTagsContainer: document.getElementById('taskTagsContainer'),
            tagSelection: document.getElementById('tagSelection'),
            availableTags: document.getElementById('availableTags'),
            checklistItems: document.getElementById('checklistItems'),
            newChecklistItem: document.getElementById('newChecklistItem'),
            imagePreviewContainer: document.getElementById('imagePreviewContainer'),
            imagePreview: document.getElementById('imagePreview'),
            searchInput: document.getElementById('searchInput'),
            filterTags: document.getElementById('filterTags'),
            tagModal: document.getElementById('tagModal'),
            tagForm: document.getElementById('tagForm'),
            tagId: document.getElementById('tagId'),
            tagName: document.getElementById('tagName'),
            tagColor: document.getElementById('tagColor'),
            tagsList: document.getElementById('tagsList'),
            imageModal: document.getElementById('imageModal'),
            modalImage: document.getElementById('modalImage')
        };

        // Initialize the app
        function init() {
            // Load data from localStorage
            loadFromLocalStorage();
            
            // Check authentication
            if (!state.currentUser) {
                showAuthModal('login');
            } else {
                updateUI();
                loadTasks(state.currentList);
            }
            
            // Set up event listeners
            setupEventListeners();
        }

        // Load data from localStorage
        function loadFromLocalStorage() {
            const user = localStorage.getItem('currentUser');
            if (user) {
                state.currentUser = JSON.parse(user);
            }
            
            const tasks = localStorage.getItem('tasks');
            if (tasks) {
                state.tasks = JSON.parse(tasks);
            }
            
            const projects = localStorage.getItem('projects');
            if (projects) {
                state.projects = JSON.parse(projects);
            }
            
            const tags = localStorage.getItem('tags');
            if (tags) {
                state.tags = JSON.parse(tags);
            }
            
            // Asegurarse que el estado tiene las estructuras necesarias
            ensureStateStructure();
        }

        // Save data to localStorage
        function saveToLocalStorage() {
            localStorage.setItem('currentUser', JSON.stringify(state.currentUser));
            localStorage.setItem('tasks', JSON.stringify(state.tasks));
            localStorage.setItem('projects', JSON.stringify(state.projects));
            localStorage.setItem('tags', JSON.stringify(state.tags));
        }

        // Set up event listeners
        function setupEventListeners() {
            // Auth forms
            elements.loginForm.addEventListener('submit', handleLogin);
            elements.registerForm.addEventListener('submit', handleRegister);
            
            // Task form
            elements.taskForm.addEventListener('submit', handleTaskSubmit);
            
            // Tag form
            elements.tagForm.addEventListener('submit', handleTagSubmit);
            
            // Search input
            elements.searchInput.addEventListener('input', handleSearch);
            
            // Drag and drop events
            document.addEventListener('dragstart', handleDragStart);
            document.addEventListener('dragover', handleDragOver);
            document.addEventListener('dragleave', handleDragLeave);
            document.addEventListener('drop', handleDrop);
            document.addEventListener('dragend', handleDragEnd);
        }

        // Update UI based on state
        function updateUI() {
            // User info
            if (state.currentUser) {
                elements.userInitial.textContent = state.currentUser.name.charAt(0).toUpperCase();
                elements.userName.textContent = state.currentUser.name;
            }
            
            // Projects list
            renderProjects();
            
            // Tags list
            renderTags();
        }

        // Auth modal functions
        function showAuthModal(tab = 'login') {
            elements.authModal.classList.remove('hidden');
            showAuthTab(tab);
        }

        function closeAuthModal() {
            elements.authModal.classList.add('hidden');
        }

        function showAuthTab(tab) {
            if (tab === 'login') {
                elements.loginTab.classList.remove('hidden');
                elements.registerTab.classList.add('hidden');
                elements.authModalTitle.textContent = 'Iniciar Sesión';
            } else {
                elements.loginTab.classList.add('hidden');
                elements.registerTab.classList.remove('hidden');
                elements.authModalTitle.textContent = 'Registrarse';
            }
        }

        // Handle login
        function handleLogin(e) {
            e.preventDefault();
            
            const email = elements.loginEmail.value;
            const password = elements.loginPassword.value;
            
            // In a real app, this would be an API call
            // For demo purposes, we'll just check if the user exists in localStorage
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const user = users.find(u => u.email === email && u.password === password);
            
            if (user) {
                state.currentUser = user;
                saveToLocalStorage();
                closeAuthModal();
                updateUI();
                loadTasks('inbox');
            } else {
                alert('Email o contraseña incorrectos');
            }
        }

        // Handle register
        function handleRegister(e) {
            e.preventDefault();
            
            const name = elements.registerName.value;
            const email = elements.registerEmail.value;
            const password = elements.registerPassword.value;
            const confirmPassword = elements.registerConfirmPassword.value;
            
            if (password !== confirmPassword) {
                alert('Las contraseñas no coinciden');
                return;
            }
            
            // In a real app, this would be an API call
            // For demo purposes, we'll just save to localStorage
            const users = JSON.parse(localStorage.getItem('users')) || [];
            
            if (users.some(u => u.email === email)) {
                alert('Este email ya está registrado');
                return;
            }
            
            const newUser = {
                id: Date.now().toString(),
                name,
                email,
                password
            };
            
            users.push(newUser);
            localStorage.setItem('users', JSON.stringify(users));
            
            state.currentUser = newUser;
            saveToLocalStorage();
            closeAuthModal();
            updateUI();
            loadTasks('inbox');
            
            // Create default projects
            if (state.projects.length === 0) {
                state.projects = [
                    { id: 'p1', name: 'Personal', userId: newUser.id },
                    { id: 'p2', name: 'Trabajo', userId: newUser.id }
                ];
                saveToLocalStorage();
                renderProjects();
            }
        }

        // Logout
        function logout() {
            state.currentUser = null;
            saveToLocalStorage();
            showAuthModal('login');
        }

        // Toggle sidebar on mobile
        function toggleSidebar() {
            elements.sidebar.classList.toggle('sidebar-mobile-hidden');
        }

        // Projects functions
        function showNewProjectForm() {
            elements.newProjectForm.classList.remove('hidden');
        }

        function hideNewProjectForm() {
            elements.newProjectForm.classList.add('hidden');
            elements.newProjectName.value = '';
        }

        function addProject() {
            const name = elements.newProjectName.value.trim();
            
            if (!name) {
                alert('Por favor ingresa un nombre para el proyecto');
                return;
            }
            
            const newProject = {
                id: 'p' + Date.now().toString(),
                name,
                userId: state.currentUser.id
            };
            
            state.projects.push(newProject);
            saveToLocalStorage();
            renderProjects();
            hideNewProjectForm();
        }

        function deleteProject(id) {
            if (confirm('¿Estás seguro de que quieres eliminar este proyecto? Las tareas no se eliminarán.')) {
                state.projects = state.projects.filter(p => p.id !== id);
                
                // Move tasks from this project to Inbox
                state.tasks = state.tasks.map(task => {
                    if (task.projectId === id) {
                        return { ...task, projectId: null, list: 'inbox' };
                    }
                    return task;
                });
                
                saveToLocalStorage();
                renderProjects();
                loadTasks(state.currentList);
            }
        }

        function renderProjects() {
            if (!state.currentUser) return;
            
            elements.projectsList.innerHTML = '';
            
            const userProjects = state.projects.filter(p => p.userId === state.currentUser.id);
            
            if (userProjects.length === 0) {
                elements.projectsList.innerHTML = '<p class="text-sm text-gray-500">No hay proyectos</p>';
                return;
            }
            
            userProjects.forEach(project => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between group';
                
                const link = document.createElement('a');
                link.href = '#';
                link.className = 'flex items-center space-x-2 py-2 px-2 rounded hover:bg-gray-100 text-gray-700 flex-1';
                link.innerHTML = `<i class="fas fa-folder w-5 text-blue-500"></i> <span>${project.name}</span>`;
                link.onclick = (e) => {
                    e.preventDefault();
                    loadTasks('project', project.id);
                };
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 p-1';
                deleteBtn.innerHTML = '<i class="fas fa-trash text-xs"></i>';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteProject(project.id);
                };
                
                li.appendChild(link);
                li.appendChild(deleteBtn);
                elements.projectsList.appendChild(li);
            });
        }

        // Tags functions
        function openTagModal(tag = null) {
            elements.tagModal.classList.remove('hidden');
            
            if (tag) {
                elements.tagModalTitle.textContent = 'Editar Etiqueta';
                elements.tagId.value = tag.id;
                elements.tagName.value = tag.name;
                elements.tagColor.value = tag.color;
                
                // Update color picker selection
                document.querySelectorAll('.tag-color-option').forEach(option => {
                    option.classList.remove('selected');
                    if (option.classList.contains(`bg-${tag.color}`)) {
                        option.classList.add('selected');
                    }
                });
            } else {
                elements.tagModalTitle.textContent = 'Nueva Etiqueta';
                elements.tagId.value = '';
                elements.tagName.value = '';
                elements.tagColor.value = 'blue-500';
                
                // Reset color picker selection
                document.querySelectorAll('.tag-color-option').forEach(option => {
                    option.classList.remove('selected');
                    if (option.classList.contains('bg-blue-500')) {
                        option.classList.add('selected');
                    }
                });
            }
        }

        function closeTagModal() {
            elements.tagModal.classList.add('hidden');
        }

        function selectTagColor(color) {
            elements.tagColor.value = color;
            
            document.querySelectorAll('.tag-color-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            document.querySelector(`.tag-color-option.bg-${color}`).classList.add('selected');
        }

        function handleTagSubmit(e) {
            e.preventDefault();
            
            const id = elements.tagId.value;
            const name = elements.tagName.value.trim();
            const color = elements.tagColor.value;
            
            if (!name) {
                alert('Por favor ingresa un nombre para la etiqueta');
                return;
            }
            
            if (id) {
                // Update existing tag
                const index = state.tags.findIndex(t => t.id === id);
                if (index !== -1) {
                    state.tags[index] = { ...state.tags[index], name, color };
                }
            } else {
                // Add new tag
                const newTag = {
                    id: 't' + Date.now().toString(),
                    name,
                    color,
                    userId: state.currentUser.id
                };
                
                state.tags.push(newTag);
            }
            
            saveToLocalStorage();
            renderTags();
            closeTagModal();
        }

        function deleteTag(id) {
            if (confirm('¿Estás seguro de que quieres eliminar esta etiqueta? Se eliminará de todas las tareas.')) {
                // Remove tag from tasks
                state.tasks = state.tasks.map(task => {
                    if (task.tags && task.tags.includes(id)) {
                        return { ...task, tags: task.tags.filter(tagId => tagId !== id) };
                    }
                    return task;
                });
                
                // Remove tag from state
                state.tags = state.tags.filter(t => t.id !== id);
                
                saveToLocalStorage();
                renderTags();
                
                // Reload tasks if we're filtering by this tag
                if (state.activeTagFilters.includes(id)) {
                    removeTagFilter(id);
                }
            }
        }

        function renderTags() {
            if (!state.currentUser) return;
            
            elements.tagsList.innerHTML = '';
            
            const userTags = state.tags.filter(t => t.userId === state.currentUser.id);
            
            if (userTags.length === 0) {
                elements.tagsList.innerHTML = '<p class="text-sm text-gray-500">No hay etiquetas</p>';
                return;
            }
            
            userTags.forEach(tag => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between group';
                
                const link = document.createElement('a');
                link.href = '#';
                link.className = 'flex items-center space-x-2 py-2 px-2 rounded hover:bg-gray-100 text-gray-700 flex-1';
                link.innerHTML = `<span class="w-3 h-3 rounded-full bg-${tag.color}"></span> <span>${tag.name}</span>`;
                link.onclick = (e) => {
                    e.preventDefault();
                    addTagFilter(tag.id);
                };
                
                const editBtn = document.createElement('div');
                editBtn.className = 'flex space-x-1 opacity-0 group-hover:opacity-100';
                
                const editButton = document.createElement('button');
                editButton.className = 'text-gray-400 hover:text-blue-500 p-1';
                editButton.innerHTML = '<i class="fas fa-edit text-xs"></i>';
                editButton.onclick = (e) => {
                    e.stopPropagation();
                    openTagModal(tag);
                };
                
                const deleteButton = document.createElement('button');
                deleteButton.className = 'text-gray-400 hover:text-red-500 p-1';
                deleteButton.innerHTML = '<i class="fas fa-trash text-xs"></i>';
                deleteButton.onclick = (e) => {
                    e.stopPropagation();
                    deleteTag(tag.id);
                };
                
                editBtn.appendChild(editButton);
                editBtn.appendChild(deleteButton);
                
                li.appendChild(link);
                li.appendChild(editBtn);
                elements.tagsList.appendChild(li);
            });
        }

        // Tasks functions
        function loadTasks(list, projectId = null) {
            state.currentList = list;
            
            // Update UI
            if (list === 'project') {
                const project = state.projects.find(p => p.id === projectId);
                elements.currentListTitle.textContent = project ? project.name : 'Proyecto';
            } else {
                const listTitles = {
                    inbox: 'Inbox',
                    today: 'Hoy',
                    upcoming: 'Próximas',
                    anytime: 'En cualquier momento',
                    someday: 'Algún día',
                    logbook: 'Logbook'
                };
                elements.currentListTitle.textContent = listTitles[list] || 'Tareas';
            }
            
            // Filter tasks based on current list and search
            let filteredTasks = filterTasks(list, projectId);
            
            // Render tasks
            renderTasks(filteredTasks);
            
            // Close sidebar on mobile
            if (window.innerWidth < 768) {
                elements.sidebar.classList.add('sidebar-mobile-hidden');
            }
        }

        function filterTasks(list, projectId = null) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            let filteredTasks = [...state.tasks];
            
            // Filter by user
            filteredTasks = filteredTasks.filter(task => task.userId === state.currentUser.id);
            
            // Filter by list or project
            if (list === 'project') {
                filteredTasks = filteredTasks.filter(task => task.projectId === projectId && !task.completed);
            } else if (list === 'today') {
                filteredTasks = filteredTasks.filter(task => {
                    if (task.completed) return false;
                    if (!task.dueDate) return false;
                    
                    const dueDate = new Date(task.dueDate);
                    return dueDate >= today && dueDate < tomorrow;
                });
            } else if (list === 'upcoming') {
                filteredTasks = filteredTasks.filter(task => {
                    if (task.completed) return false;
                    if (!task.dueDate) return false;
                    
                    const dueDate = new Date(task.dueDate);
                    return dueDate >= tomorrow;
                });
            } else if (list === 'anytime') {
                filteredTasks = filteredTasks.filter(task => !task.completed && !task.dueDate && !task.projectId);
            } else if (list === 'someday') {
                filteredTasks = filteredTasks.filter(task => !task.completed && !task.dueDate && task.list === 'someday');
            } else if (list === 'logbook') {
                filteredTasks = filteredTasks.filter(task => task.completed);
            } else { // inbox or other
                filteredTasks = filteredTasks.filter(task => !task.completed && (!task.list || task.list === 'inbox') && !task.projectId);
            }
            
            // Apply search filter
            if (state.searchQuery) {
                const query = state.searchQuery.toLowerCase();
                filteredTasks = filteredTasks.filter(task => 
                    task.title.toLowerCase().includes(query) || 
                    (task.notes && task.notes.toLowerCase().includes(query))
                );
            }
            
            // Apply tag filters
            if (state.activeTagFilters.length > 0) {
                filteredTasks = filteredTasks.filter(task => 
                    task.tags && state.activeTagFilters.every(tagId => task.tags.includes(tagId))
                );
            }
            
            return filteredTasks;
        }

        function renderTasks(tasks) {
            elements.tasksContainer.innerHTML = '';
            
            if (tasks.length === 0) {
                elements.tasksContainer.innerHTML = `
                    <div class="text-center py-10 text-gray-500">
                        <i class="fas fa-tasks text-4xl mb-2"></i>
                        <p>No hay tareas en esta lista</p>
                    </div>
                `;
                return;
            }
            
            // Group tasks by parent (for headers)
            const tasksWithSubtasks = tasks.filter(task => task.parentId);
            const parentTasks = tasks.filter(task => !task.parentId);
            
            // Create dropzone for the list
            const dropzone = document.createElement('div');
            dropzone.className = 'dropzone mb-4 rounded-md p-2';
            dropzone.setAttribute('data-list', state.currentList);
            dropzone.setAttribute('data-project-id', state.currentList === 'project' ? tasks[0]?.projectId : '');
            
            parentTasks.forEach(task => {
                // Find subtasks for this parent
                const subtasks = tasksWithSubtasks.filter(t => t.parentId === task.id);
                
                // Render parent task
                const taskElement = createTaskElement(task, subtasks.length > 0);
                dropzone.appendChild(taskElement);
                
                // Render subtasks if expanded
                if (task.expanded && subtasks.length > 0) {
                    const subtasksContainer = document.createElement('div');
                    subtasksContainer.className = 'ml-8 mt-1 space-y-1';
                    
                    subtasks.forEach(subtask => {
                        const subtaskElement = createTaskElement(subtask, false);
                        subtasksContainer.appendChild(subtaskElement);
                    });
                    
                    dropzone.appendChild(subtasksContainer);
                }
            });
            
            elements.tasksContainer.appendChild(dropzone);
        }

        function createTaskElement(task, hasSubtasks) {
            const taskElement = document.createElement('div');
            taskElement.className = 'task-item bg-white border border-gray-200 rounded-md p-3 hover:shadow-sm transition-shadow duration-200 flex items-start';
            taskElement.setAttribute('draggable', 'true');
            taskElement.setAttribute('data-task-id', task.id);
            
            // Checkbox
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'mt-1 mr-3';
            checkbox.checked = task.completed || false;
            checkbox.onchange = () => toggleTaskCompletion(task.id);
            
            // Task content
            const content = document.createElement('div');
            content.className = 'flex-1';
            
            // Task title
            const title = document.createElement('div');
            title.className = `font-medium ${task.completed ? 'line-through text-gray-400' : 'text-gray-800'}`;
            title.textContent = task.title;
            
            // Task meta (due date, tags, etc.)
            const meta = document.createElement('div');
            meta.className = 'flex flex-wrap items-center gap-2 mt-1 text-xs text-gray-500';
            
            // Due date
            if (task.dueDate) {
                const dueDate = new Date(task.dueDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const dueDateEl = document.createElement('span');
                dueDateEl.className = 'flex items-center';
                
                if (dueDate < today && !task.completed) {
                    dueDateEl.classList.add('text-red-500');
                } else if (dueDate.toDateString() === today.toDateString() && !task.completed) {
                    dueDateEl.classList.add('text-blue-500');
                }
                
                dueDateEl.innerHTML = `<i class="fas fa-calendar-day mr-1"></i> ${formatDate(dueDate)}`;
                meta.appendChild(dueDateEl);
            }
            
            

// Tags
if (task.tags && task.tags.length > 0) {
    task.tags.forEach(tagId => {
        const tag = state.tags.find(t => t.id === tagId);
        if (tag) {
            const tagEl = document.createElement('span');
            tagEl.className = `inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-${tag.color}-100 text-${tag.color}-800`;
            tagEl.textContent = tag.name;
            meta.appendChild(tagEl);
        }
    });
}

// Checklist progress
if (task.checklist && task.checklist.length > 0) {
    const completedItems = task.checklist.filter(item => item.completed).length;
    const progress = (completedItems / task.checklist.length) * 100;
    
    const progressContainer = document.createElement('div');
    progressContainer.className = 'w-full mt-2';
    
    const progressText = document.createElement('div');
    progressText.className = 'flex justify-between text-xs mb-1';
    progressText.innerHTML = `<span>Checklist</span> <span>${completedItems}/${task.checklist.length}</span>`;
    
    const progressBar = document.createElement('div');
    progressBar.className = 'bg-gray-200 rounded-full h-1';
    
    const progressBarFill = document.createElement('div');
    progressBarFill.className = 'checklist-progress bg-blue-500 rounded-full';
    progressBarFill.style.width = `${progress}%`;
    
    progressBar.appendChild(progressBarFill);
    progressContainer.appendChild(progressText);
    progressContainer.appendChild(progressBar);
    
    meta.appendChild(progressContainer);
}

// Image thumbnail
if (task.image) {
    const imageContainer = document.createElement('div');
    imageContainer.className = 'mt-2';
    
    const imageThumb = document.createElement('img');
    imageThumb.src = task.image;
    imageThumb.className = 'h-16 w-auto rounded border border-gray-200 cursor-pointer';
    imageThumb.onclick = () => showFullImage(task.image);
    
    imageContainer.appendChild(imageThumb);
    meta.appendChild(imageContainer);
}

// Task actions (edit, delete, etc.)
const actions = document.createElement('div');
actions.className = 'task-actions flex space-x-2 ml-2';

const expandButton = document.createElement('button');
expandButton.className = 'text-gray-400 hover:text-gray-600 p-1';
expandButton.innerHTML = hasSubtasks ? 
    `<i class="fas fa-chevron-${task.expanded ? 'down' : 'right'}"></i>` : 
    '<i class="fas fa-chevron-right opacity-0"></i>';
expandButton.onclick = (e) => {
    e.stopPropagation();
    toggleTaskExpansion(task.id);
};

const editButton = document.createElement('button');
editButton.className = 'text-gray-400 hover:text-blue-500 p-1';
editButton.innerHTML = '<i class="fas fa-edit"></i>';
editButton.onclick = (e) => {
    e.stopPropagation();
    showTaskModal(task);
};

const deleteButton = document.createElement('button');
deleteButton.className = 'text-gray-400 hover:text-red-500 p-1';
deleteButton.innerHTML = '<i class="fas fa-trash"></i>';
deleteButton.onclick = (e) => {
    e.stopPropagation();
    deleteTask(task.id);
};

actions.appendChild(expandButton);
actions.appendChild(editButton);
actions.appendChild(deleteButton);

content.appendChild(title);
content.appendChild(meta);

taskElement.appendChild(checkbox);
taskElement.appendChild(content);
taskElement.appendChild(actions);

return taskElement;
}

function showTaskModal(task = null) {
    elements.taskModal.classList.remove('hidden');
    
    if (task) {
        elements.taskModalTitle.textContent = 'Editar Tarea';
        elements.taskId.value = task.id;
        elements.taskTitle.value = task.title;
        elements.taskNotes.value = task.notes || '';
        elements.taskDueDate.value = task.dueDate || '';
        elements.taskList.value = task.list || 'inbox';
        
        // Set parent task dropdown
        elements.taskParent.innerHTML = '<option value="">Ninguna</option>';
        const parentTasks = state.tasks.filter(t => 
            t.userId === state.currentUser.id && 
            !t.completed && 
            t.id !== task.id && 
            (!t.parentId || t.parentId !== task.id) // Avoid circular references
        );
        
        parentTasks.forEach(parent => {
            const option = document.createElement('option');
            option.value = parent.id;
            option.textContent = parent.title;
            option.selected = task.parentId === parent.id;
            elements.taskParent.appendChild(option);
        });
        
        // Set tags
        renderTaskTags(task.tags || []);
        
        // Set checklist
        renderChecklistItems(task.checklist || []);
        
        // Set image preview if exists
        if (task.image) {
            elements.imagePreview.src = task.image;
            elements.imagePreviewContainer.classList.remove('hidden');
        } else {
            elements.imagePreviewContainer.classList.add('hidden');
        }
    } else {
        elements.taskModalTitle.textContent = 'Nueva Tarea';
        elements.taskId.value = '';
        elements.taskTitle.value = '';
        elements.taskNotes.value = '';
        elements.taskDueDate.value = '';
        elements.taskList.value = state.currentList;
        elements.taskParent.innerHTML = '<option value="">Ninguna</option>';
        
        // Add available parent tasks
        const parentTasks = state.tasks.filter(t => 
            t.userId === state.currentUser.id && 
            !t.completed
        );
        
        parentTasks.forEach(parent => {
            const option = document.createElement('option');
            option.value = parent.id;
            option.textContent = parent.title;
            elements.taskParent.appendChild(option);
        });
        
        // Clear tags
        renderTaskTags([]);
        
        // Clear checklist
        renderChecklistItems([]);
        
        // Clear image
        elements.imagePreviewContainer.classList.add('hidden');
        elements.taskImage.value = '';
    }
}

function closeTaskModal() {
    elements.taskModal.classList.add('hidden');
}

function handleTaskSubmit(e) {
    e.preventDefault();
    
    // Asegurar que el estado tiene las estructuras necesarias
    ensureStateStructure();
    
    const id = elements.taskId.value;
    const title = elements.taskTitle.value.trim();
    const notes = elements.taskNotes.value.trim();
    const dueDate = elements.taskDueDate.value;
    const parentId = elements.taskParent.value;
    const list = elements.taskList.value || 'inbox';
    
    if (!title) {
        alert('Por favor ingresa un título para la tarea');
        return;
    }
    
    // Get selected tags
    const selectedTags = [];
    document.querySelectorAll('#taskTagsContainer [data-tag-id]').forEach(el => {
        selectedTags.push(el.getAttribute('data-tag-id'));
    });
    
    // Get checklist items
    const checklist = [];
    document.querySelectorAll('#checklistItems [data-checklist-id]').forEach(el => {
        const checklistId = el.getAttribute('data-checklist-id');
        const text = el.querySelector('input[type="text"]').value;
        const completed = el.querySelector('input[type="checkbox"]').checked;
        
        if (text.trim()) {
            checklist.push({
                id: checklistId,
                text: text.trim(),
                completed
            });
        }
    });
    
    if (id) {
        // Update existing task
        const index = state.tasks.findIndex(t => t.id === id);
        if (index !== -1) {
            const updatedTask = {
                ...state.tasks[index],
                title,
                notes,
                dueDate,
                parentId: parentId || null,
                list,
                tags: selectedTags,
                checklist,
                image: elements.imagePreview.src || null
            };
            
            state.tasks[index] = updatedTask;
        }
    } else {
        // Add new task
        const newTask = {
            id: 'task' + Date.now().toString(),
            userId: state.currentUser.id,
            title,
            notes,
            dueDate,
            parentId: parentId || null,
            list,
            tags: selectedTags,
            checklist,
            image: elements.imagePreview.src || null,
            completed: false,
            expanded: false,
            createdAt: new Date().toISOString()
        };
        
        // If it's a project task, set the projectId
        if (state.currentList === 'project') {
            const projectId = filterTasks(state.currentList)[0]?.projectId;
            if (projectId) {
                newTask.projectId = projectId;
                newTask.list = null;
            }
        }
        
        state.tasks.push(newTask);
    }
    
    saveToLocalStorage();
    loadTasks(state.currentList);
    closeTaskModal();
}

function toggleTaskCompletion(id) {
            const task = state.tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                task.completedAt = task.completed ? new Date().toISOString() : null;
                saveToLocalStorage();
                loadTasks(state.currentList);
            }
        }

        function toggleTaskExpansion(id) {
            const task = state.tasks.find(t => t.id === id);
            if (task) {
                task.expanded = !task.expanded;
                saveToLocalStorage();
                loadTasks(state.currentList);
            }
        }

        function deleteTask(id) {
            if (confirm('¿Estás seguro de que quieres eliminar esta tarea?')) {
                // First, check if this task has subtasks
                const hasSubtasks = state.tasks.some(t => t.parentId === id);
                
                if (hasSubtasks) {
                    if (!confirm('Esta tarea tiene subtareas. ¿Quieres eliminarlas también?')) {
                        return;
                    }
                    
                    // Delete subtasks
                    state.tasks = state.tasks.filter(t => t.parentId !== id);
                }
                
                // Delete the task
                state.tasks = state.tasks.filter(t => t.id !== id);
                saveToLocalStorage();
                loadTasks(state.currentList);
            }
        }

        // Task tags functions
        function renderTaskTags(tagIds) {
            elements.taskTagsContainer.innerHTML = '';
            
            tagIds.forEach(tagId => {
                const tag = state.tags.find(t => t.id === tagId);
                if (tag) {
                    const tagEl = document.createElement('span');
                    tagEl.className = `inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-${tag.color}-100 text-${tag.color}-800`;
                    tagEl.textContent = tag.name;
                    tagEl.setAttribute('data-tag-id', tag.id);
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'ml-1 text-gray-500 hover:text-gray-700';
                    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                    removeBtn.onclick = () => {
                        tagEl.remove();
                    };
                    
                    tagEl.appendChild(removeBtn);
                    elements.taskTagsContainer.appendChild(tagEl);
                }
            });
        }

        function showTagSelection() {
            elements.tagSelection.classList.remove('hidden');
            
            // Show available tags
            elements.availableTags.innerHTML = '';
            
            const currentTagIds = Array.from(elements.taskTagsContainer.querySelectorAll('[data-tag-id]')).map(el => el.getAttribute('data-tag-id'));
            
            state.tags.forEach(tag => {
                if (!currentTagIds.includes(tag.id)) {
                    const tagEl = document.createElement('button');
                    tagEl.type = 'button';
                    tagEl.className = `inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-${tag.color}-100 text-${tag.color}-800 hover:bg-${tag.color}-200`;
                    tagEl.textContent = tag.name;
                    tagEl.onclick = () => {
                        const existingTag = elements.taskTagsContainer.querySelector(`[data-tag-id="${tag.id}"]`);
                        if (!existingTag) {
                            const newTagEl = document.createElement('span');
                            newTagEl.className = `inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-${tag.color}-100 text-${tag.color}-800`;
                            newTagEl.textContent = tag.name;
                            newTagEl.setAttribute('data-tag-id', tag.id);
                            
                            const removeBtn = document.createElement('button');
                            removeBtn.className = 'ml-1 text-gray-500 hover:text-gray-700';
                            removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                            removeBtn.onclick = () => {
                                newTagEl.remove();
                            };
                            
                            newTagEl.appendChild(removeBtn);
                            elements.taskTagsContainer.appendChild(newTagEl);
                        }
                    };
                    
                    elements.availableTags.appendChild(tagEl);
                }
            });
        }

        function hideTagSelection() {
            elements.tagSelection.classList.add('hidden');
        }

        // Checklist functions
        function renderChecklistItems(items) {
            elements.checklistItems.innerHTML = '';
            
            items.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'flex items-center mb-2';
                itemEl.setAttribute('data-checklist-id', item.id);
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'mr-2';
                checkbox.checked = item.completed;
                
                const textInput = document.createElement('input');
                textInput.type = 'text';
                textInput.className = 'flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm';
                textInput.value = item.text;
                textInput.placeholder = 'Ítem de checklist';
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'ml-2 text-red-500 hover:text-red-700';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.onclick = () => {
                    itemEl.remove();
                };
                
                itemEl.appendChild(checkbox);
                itemEl.appendChild(textInput);
                itemEl.appendChild(deleteBtn);
                elements.checklistItems.appendChild(itemEl);
            });
        }

        function addChecklistItem() {
            const text = elements.newChecklistItem.value.trim();
            if (!text) return;
            
            const itemEl = document.createElement('div');
            itemEl.className = 'flex items-center mb-2';
            itemEl.setAttribute('data-checklist-id', 'item' + Date.now());
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'mr-2';
            
            const textInput = document.createElement('input');
            textInput.type = 'text';
            textInput.className = 'flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm';
            textInput.value = text;
            textInput.placeholder = 'Ítem de checklist';
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'ml-2 text-red-500 hover:text-red-700';
            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
            deleteBtn.onclick = () => {
                itemEl.remove();
            };
            
            itemEl.appendChild(checkbox);
            itemEl.appendChild(textInput);
            itemEl.appendChild(deleteBtn);
            elements.checklistItems.appendChild(itemEl);
            
            elements.newChecklistItem.value = '';
        }

        // Image functions
        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    elements.imagePreview.src = e.target.result;
                    elements.imagePreviewContainer.classList.remove('hidden');
                };
                
                reader.readAsDataURL(input.files[0]);
            }
        }

        function removeImage() {
            elements.imagePreview.src = '';
            elements.imagePreviewContainer.classList.add('hidden');
            elements.taskImage.value = '';
        }

        function showFullImage(src) {
            elements.modalImage.src = src;
            elements.imageModal.classList.remove('hidden');
        }

        function closeImageModal() {
            elements.imageModal.classList.add('hidden');
        }

        // Search and filter functions
        function handleSearch(e) {
            state.searchQuery = e.target.value;
            loadTasks(state.currentList);
        }

        function addTagFilter(tagId) {
            if (!state.activeTagFilters.includes(tagId)) {
                state.activeTagFilters.push(tagId);
                renderActiveTagFilters();
                loadTasks(state.currentList);
            }
        }

        function removeTagFilter(tagId) {
            state.activeTagFilters = state.activeTagFilters.filter(id => id !== tagId);
            renderActiveTagFilters();
            loadTasks(state.currentList);
        }

        function renderActiveTagFilters() {
            elements.filterTags.innerHTML = '';
            
            if (state.activeTagFilters.length === 0) {
                elements.filterTags.classList.add('hidden');
                return;
            }
            
            elements.filterTags.classList.remove('hidden');
            
            state.activeTagFilters.forEach(tagId => {
                const tag = state.tags.find(t => t.id === tagId);
                if (tag) {
                    const tagEl = document.createElement('span');
                    tagEl.className = `inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-${tag.color}-100 text-${tag.color}-800`;
                    
                    const tagName = document.createElement('span');
                    tagName.textContent = tag.name;
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'ml-1 text-gray-500 hover:text-gray-700';
                    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                    removeBtn.onclick = () => {
                        removeTagFilter(tag.id);
                    };
                    
                    tagEl.appendChild(tagName);
                    tagEl.appendChild(removeBtn);
                    elements.filterTags.appendChild(tagEl);
                }
            });
        }

        // Drag and drop functions
        function handleDragStart(e) {
            if (e.target.classList.contains('task-item')) {
                elements.draggedTask = e.target;
                e.target.classList.add('task-dragging');
                e.dataTransfer.setData('text/plain', e.target.getAttribute('data-task-id'));
                e.dataTransfer.effectAllowed = 'move';
            }
        }

        function handleDragOver(e) {
            if (e.target.classList.contains('dropzone')) {
                e.preventDefault();
                e.target.classList.add('dropzone-active');
                e.dataTransfer.dropEffect = 'move';
            }
        }

        function handleDragLeave(e) {
            if (e.target.classList.contains('dropzone')) {
                e.target.classList.remove('dropzone-active');
            }
        }

        function handleDrop(e) {
            if (e.target.classList.contains('dropzone')) {
                e.preventDefault();
                e.target.classList.remove('dropzone-active');
                
                const taskId = e.dataTransfer.getData('text/plain');
                const newList = e.target.getAttribute('data-list');
                const projectId = e.target.getAttribute('data-project-id');
                
                // Find the task
                const taskIndex = state.tasks.findIndex(t => t.id === taskId);
                if (taskIndex !== -1) {
                    const updatedTask = { ...state.tasks[taskIndex] };
                    
                    // Update list/project
                    if (newList === 'project') {
                        updatedTask.projectId = projectId;
                        updatedTask.list = null;
                    } else {
                        updatedTask.list = newList;
                        updatedTask.projectId = null;
                    }
                    
                    // Remove parent if moving to a different list
                    if (updatedTask.parentId) {
                        const parentTask = state.tasks.find(t => t.id === updatedTask.parentId);
                        if (parentTask && 
                            (parentTask.list !== newList || parentTask.projectId !== projectId)) {
                            updatedTask.parentId = null;
                        }
                    }
                    
                    state.tasks[taskIndex] = updatedTask;
                    saveToLocalStorage();
                    loadTasks(state.currentList);
                }
            }
        }

        function handleDragEnd(e) {
            if (elements.draggedTask) {
                elements.draggedTask.classList.remove('task-dragging');
                elements.draggedTask = null;
            }
            
            document.querySelectorAll('.dropzone').forEach(dz => {
                dz.classList.remove('dropzone-active');
            });
        }

        // Helper functions
        function formatDate(date) {
            const options = { weekday: 'short', day: 'numeric', month: 'short' };
            return date.toLocaleDateString('es-ES', options);
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>